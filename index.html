<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Daily Sales Report</title>

  <!-- Khmer Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Noto Sans Khmer', sans-serif; }
    .print-only { display: none; }
    .screen-only { display: block; }
    @media print {
      button, .hidden-print, .screen-only { display: none !important; }
      .print-only { display: block !important; }
      body { background: #fff; }
      .shadow, .rounded-2xl, .bg-white, .dark\:bg-gray-900 { 
        box-shadow: none !important; border-radius: 0 !important; background: #fff !important; 
      }
    }
    .capture-mode button,
    .capture-mode .hidden-print,
    .capture-mode .screen-only { display: none !important; }
    .capture-mode .print-only { display: block !important; }
  </style>
</head>

<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 p-4">
  <div id="reportCard" class="max-w-3xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-2xl shadow">

    <!-- Sticky Header -->
    <div class="sticky top-0 bg-white dark:bg-gray-800 z-20 pb-2 border-b border-gray-200 dark:border-gray-700">
      <h1 class="text-2xl font-bold text-center py-2">
        ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†ááŸ’á„áŸƒ<br />
        <span class="text-sm">(Daily Sales Report)</span>
      </h1>
      <div class="mb-2 flex justify-between items-center">
        <label class="text-sm">á€á¶á›á”ášá·á…áŸ’á†áŸá‘ (Date)</label>
        <input type="date" id="reportDate"
          class="p-1 border rounded screen-only bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        <div class="print-only text-sm mt-1">Date: <span id="dateFormattedPrint">â€”</span></div>
      </div>
    </div>

    <!-- Sales -->
    <h2 class="text-xl font-semibold mb-2 mt-4">I. á€á¶ášá›á€áŸ‹ (Sales)</h2>
    <table class="w-full border text-sm mb-3 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100">
      <thead class="bg-gray-100 dark:bg-gray-700">
        <tr>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Customer</th>
          <th class="border px-2 py-1 text-right dark:border-gray-600">Amount (áŸ›)</th>
        </tr>
      </thead>
      <tbody id="salesContainer"></tbody>
    </table>
    <button id="btnAddSale" class="bg-blue-500 text-white px-3 py-1 rounded hidden-print flex items-center gap-2
           dark:bg-blue-600 dark:hover:bg-blue-500">â• Customer</button>
    <div class="mt-2 font-bold">áŸášá»á”á€á¶ášá›á€áŸ‹ (A) Total Sales: <span id="totalSales">0</span> áŸ›</div>

    <!-- Purchases -->
    <h2 class="text-xl font-semibold mt-6 mb-2">II. á€á¶ášá‘á·á‰ (Purchases)</h2>
    <table class="w-full border text-sm mb-3 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100">
      <thead class="bg-gray-100 dark:bg-gray-700">
        <tr>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Supplier</th>
          <th class="border px-2 py-1 text-right dark:border-gray-600">Amount (áŸ›)</th>
        </tr>
      </thead>
      <tbody id="purchaseContainer"></tbody>
    </table>
    <button id="btnAddPurchase" class="bg-green-500 text-white px-3 py-1 rounded hidden-print flex items-center gap-2
           dark:bg-green-600 dark:hover:bg-green-500">ğŸ“¦ Supplier</button>
    <div class="mt-2 font-bold">áŸášá»á”á€á¶ášá‘á·á‰ (B) Total Purchases: <span id="totalPurchases">0</span> áŸ›</div>

    <!-- Expenses -->
    <h2 class="text-xl font-semibold mt-6 mb-2">III. á€á¶ášá…áŸ†áá¶á™ (Expenses)</h2>
    <table class="w-full border text-sm mb-3 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100">
      <thead class="bg-gray-100 dark:bg-gray-700">
        <tr>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Expense Type</th>
          <th class="border px-2 py-1 text-right dark:border-gray-600">Amount (áŸ›)</th>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Note</th>
        </tr>
      </thead>
      <tbody id="expenseContainer"></tbody>
    </table>
    <button id="btnAddExpense" class="bg-yellow-500 text-white px-3 py-1 rounded hidden-print flex items-center gap-2
           dark:bg-yellow-600 dark:hover:bg-yellow-500">ğŸ’° Expense</button>
    <div class="mt-2 font-bold">áŸášá»á”á…áŸ†áá¶á™ (C) Total Expenses: <span id="totalExpenses">0</span> áŸ›</div>

    <!-- Totals -->
    <div class="mt-6 space-y-2">
      <div class="flex justify-between items-center">
        <label class="font-semibold">IV. á…áŸ†ááŸá‰áŸášá»á” (D=A-B-C) Total Profit:</label>
        <span id="totalProfit" class="font-bold">0 áŸ›</span>
      </div>
      <div class="flex justify-between items-center">
        <label class="font-semibold">V. á‘á¹á€á”áŸ’ášá¶á€áŸ‹ááŸ’ášá¼áœá•áŸ’á‘áŸáš (E=B+C):</label>
        <span id="totalTransfer" class="font-bold text-purple-700">0 áŸ›</span>
      </div>
      <div class="flex justify-between items-center">
        <label class="font-semibold">VI. á”áŸ’ášá¶á€áŸ‹á€á€áŸ‹ (F) Petty Cash Balance:</label>
        <input type="number" id="pettyCash"
               class="w-32 p-2 border rounded text-right screen-only bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        <span class="print-only" id="pettyCashPrint">0</span>
      </div>
    </div>

    <!-- Buttons -->
    <div class="mt-4 space-y-2 hidden-print">
      <!-- Share first -->
      <button id="btnShareTelegram" class="w-full bg-sky-600 text-white py-2 rounded dark:bg-sky-700 dark:hover:bg-sky-600">Share to Telegram</button>
      <button id="btnSaveImage" class="w-full bg-emerald-600 text-white py-2 rounded dark:bg-emerald-700 dark:hover:bg-emerald-600">Save as Image (PNG)</button>
      <button onclick="window.print()" class="w-full bg-gray-700 text-white py-2 rounded dark:bg-gray-800 dark:hover:bg-gray-600">Print</button>
      <button id="btnInstall" class="w-full bg-indigo-600 text-white py-2 rounded hidden dark:bg-indigo-700 dark:hover:bg-indigo-600">Install App</button>
      <button id="btnClearReport" class="w-full bg-red-500 text-white py-2 rounded dark:bg-red-600 dark:hover:bg-red-500">Clear Report</button>
    </div>

    <!-- Telegram Settings (pre-filled) -->
    <div class="screen-only mt-4 p-3 border rounded space-y-2 dark:border-gray-700 dark:bg-gray-800">
      <div class="text-sm font-semibold">Telegram Settings</div>
      <input id="tgBotToken" type="password"
        class="w-full p-2 border rounded bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        value="7983427142:AAHZu8g4e4YSqthm-S1p0cK_b_dF8JKZs3s" readonly />
      <input id="tgChatId" type="text"
        class="w-full p-2 border rounded bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        value="-1002294431631" readonly />
      <label class="flex items-center gap-2 text-sm">
        <input id="tgIncludeCaption" type="checkbox" class="w-4 h-4" checked />
        <span>Include caption (A/B/C/D/E totals) when sharing</span>
      </label>
      <p class="text-xs text-gray-500 dark:text-gray-400">Pre-configured for Khmer Flavor Mart group.</p>
    </div>

    <!-- Dark Mode Toggle -->
    <div class="screen-only mt-4 p-3 border rounded dark:border-gray-700 dark:bg-gray-800">
      <div class="flex justify-between items-center">
        <span class="text-sm font-semibold">Dark Mode</span>
        <label class="inline-flex items-center cursor-pointer">
          <input type="checkbox" id="darkModeToggle" class="sr-only">
          <span class="w-10 h-5 bg-gray-300 rounded-full shadow-inner flex items-center px-1 transition-colors duration-300" id="darkToggleTrack">
            <span class="w-4 h-4 bg-white rounded-full shadow transform transition-transform duration-300" id="darkToggleThumb"></span>
          </span>
        </label>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    // Helpers
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const customerList = ["General Customer","The Waters BK","The Woods LK","La Fashion BK","La Fashion LK","La Fashion BK/porridge","Tonle Bassac","Tror Khmer CKC","Lorry Eatery BTK","Jolina KTG","Dai Oun TPR","The Clay LK","Bopha TK","Lorry Eatery TTP","Kratie Eel","Heng Kimhong","Hoy Hoy CHM","Sou Sdey Vien Tien BK","Meatball 333","Other (specify)"];
    const supplierList = ["Chen Khmao","Yeay Sar (Kg Thom)","Mit Pao (Kg Chhnang)","PP Beef","Mean Mot (Krakor)","PP SC","Other (specify)"];
    const expenseTypes = ["Freight Out","Fuel Cost","Labor Cost","Miscellaneous","Other (specify)"];

    // Dropdown helper
    function createDropdownWithOther(list, cssClass) {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex gap-2 flex-1';
      const select = document.createElement('select');
      select.className = 'flex-1 p-1 border rounded '+cssClass+' bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white';
      for (const item of list) {
        const opt = document.createElement('option'); opt.value = item; opt.textContent = item; select.appendChild(opt);
      }
      const otherInput = document.createElement('input');
      otherInput.type = 'text'; otherInput.placeholder = 'Specify';
      otherInput.className = 'hidden flex-1 p-1 border rounded bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white';
      select.addEventListener('change', () => { otherInput.classList.toggle('hidden', select.value !== 'Other (specify)'); });
      wrapper.appendChild(select); wrapper.appendChild(otherInput);
      return { wrapper, select, otherInput };
    }

    // Row builders
    function addSale() {
      const row = document.createElement('tr');
      const { wrapper } = createDropdownWithOther(customerList, 'saleSelect');
      const tdName = document.createElement('td'); tdName.className = 'border px-2 py-1 dark:border-gray-600'; tdName.appendChild(wrapper);
      const tdAmt = document.createElement('td'); tdAmt.className = 'border px-2 py-1 dark:border-gray-600';
      const amt = document.createElement('input');
      amt.type='number'; amt.inputMode='numeric'; amt.placeholder='0';
      amt.className='w-full p-1 border rounded text-right saleAmount bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white';
      amt.addEventListener('input', calculateTotals);
      tdAmt.appendChild(amt);
      row.appendChild(tdName); row.appendChild(tdAmt);
      $('#salesContainer').appendChild(row); amt.focus();
    }

    function addPurchase() {
      const row = document.createElement('tr');
      const { wrapper } = createDropdownWithOther(supplierList, 'purchaseSelect');
      const tdName = document.createElement('td'); tdName.className = 'border px-2 py-1 dark:border-gray-600'; tdName.appendChild(wrapper);
      const tdAmt = document.createElement('td'); tdAmt.className = 'border px-2 py-1 dark:border-gray-600';
      const amt = document.createElement('input');
      amt.type='number'; amt.inputMode='numeric'; amt.placeholder='0';
      amt.className='w-full p-1 border rounded text-right purchaseAmount bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white';
      amt.addEventListener('input', calculateTotals);
      tdAmt.appendChild(amt);
      row.appendChild(tdName); row.appendChild(tdAmt);
      $('#purchaseContainer').appendChild(row); amt.focus();
    }

    function addExpense() {
      const row = document.createElement('tr');
      const { wrapper } = createDropdownWithOther(expenseTypes, 'expenseSelect');
      const tdType = document.createElement('td'); tdType.className = 'border px-2 py-1 dark:border-gray-600'; tdType.appendChild(wrapper);
      const tdAmt = document.createElement('td'); tdAmt.className = 'border px-2 py-1 dark:border-gray-600';
      const amt = document.createElement('input');
      amt.type='number'; amt.inputMode='numeric'; amt.placeholder='0';
      amt.className='w-full p-1 border rounded text-right expenseAmount bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white';
      amt.addEventListener('input', calculateTotals);
      tdAmt.appendChild(amt);
      const tdNote = document.createElement('td'); tdNote.className = 'border px-2 py-1 dark:border-gray-600';
      const note = document.createElement('input');
      note.type='text'; note.placeholder='Name/Note';
      note.className='w-full p-1 border rounded bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white';
      tdNote.appendChild(note);
      row.appendChild(tdType); row.appendChild(tdAmt); row.appendChild(tdNote);
      $('#expenseContainer').appendChild(row); amt.focus();
    }

    // Totals
    function calculateTotals() {
      const nsum = (nodes) => nodes.reduce((s, n) => s + Number(n.value || 0), 0);
      const totalSales = nsum($$('.saleAmount'));
      const totalPurchases = nsum($$('.purchaseAmount'));
      const totalExpenses = nsum($$('.expenseAmount'));

      $('#totalSales').textContent = totalSales.toLocaleString();
      $('#totalPurchases').textContent = totalPurchases.toLocaleString();
      $('#totalExpenses').textContent = totalExpenses.toLocaleString();

      const profit = totalSales - totalPurchases - totalExpenses;
      const transfer = totalPurchases + totalExpenses;

      const profitEl = $('#totalProfit');
      profitEl.textContent = profit.toLocaleString() + ' áŸ›';
      profitEl.className = "font-bold " + (profit > 0 ? "text-green-600" : profit < 0 ? "text-red-600" : "text-gray-600");

      $('#totalTransfer').textContent = transfer.toLocaleString() + ' áŸ›';

      localStorage.setItem('pettyCashBalance', $('#pettyCash').value || '');
      $('#pettyCashPrint').textContent = ($('#pettyCash').value || '0');

      saveReportData();
    }

    // Save/Restore
    function saveReportData() {
      const data = {
        date: $('#reportDate').value,
        pettyCash: $('#pettyCash').value,
        sales: [],
        purchases: [],
        expenses: []
      };
      $$('#salesContainer tr').forEach(row => {
        data.sales.push({
          name: row.querySelector('select').value,
          other: row.querySelector('input[type=text]')?.value || "",
          amount: row.querySelector('.saleAmount').value || ""
        });
      });
      $$('#purchaseContainer tr').forEach(row => {
        data.purchases.push({
          name: row.querySelector('select').value,
          other: row.querySelector('input[type=text]')?.value || "",
          amount: row.querySelector('.purchaseAmount').value || ""
        });
      });
      $$('#expenseContainer tr').forEach(row => {
        data.expenses.push({
          name: row.querySelector('select').value,
          other: row.querySelector('input[type=text]')?.value || "",
          amount: row.querySelector('.expenseAmount').value || "",
          note: row.querySelector('input[placeholder="Name/Note"]').value || ""
        });
      });
      localStorage.setItem("dailyReportData", JSON.stringify(data));
    }

    // Init
    (function init(){
      document.getElementById('btnAddSale').addEventListener('click', addSale);
      document.getElementById('btnAddPurchase').addEventListener('click', addPurchase);
      document.getElementById('btnAddExpense').addEventListener('click', addExpense);

      const saved = localStorage.getItem("dailyReportData");
      if(saved){
        const data = JSON.parse(saved);
        if(data.date) $('#reportDate').value = data.date;
        if(data.pettyCash) $('#pettyCash').value = data.pettyCash;
        $('#salesContainer').innerHTML=''; $('#purchaseContainer').innerHTML=''; $('#expenseContainer').innerHTML='';
        data.sales.forEach(i => { addSale(); let r=$$('#salesContainer tr').slice(-1)[0]; r.querySelector('select').value=i.name; if(i.name==="Other (specify)") r.querySelector('input[type=text]').value=i.other; r.querySelector('.saleAmount').value=i.amount; });
        data.purchases.forEach(i => { addPurchase(); let r=$$('#purchaseContainer tr').slice(-1)[0]; r.querySelector('select').value=i.name; if(i.name==="Other (specify)") r.querySelector('input[type=text]').value=i.other; r.querySelector('.purchaseAmount').value=i.amount; });
        data.expenses.forEach(i => { addExpense(); let r=$$('#expenseContainer tr').slice(-1)[0]; r.querySelector('select').value=i.name; if(i.name==="Other (specify)") r.querySelector('input[type=text]').value=i.other; r.querySelector('.expenseAmount').value=i.amount; r.querySelector('input[placeholder="Name/Note"]').value=i.note; });
      } else { addSale(); addPurchase(); addExpense(); }
      calculateTotals();

      document.getElementById('btnClearReport').addEventListener('click', ()=>{ if(confirm("Clear all saved data?")){ localStorage.removeItem("dailyReportData"); location.reload(); }});

      // Dark mode toggle
      const toggle = document.getElementById("darkModeToggle"), track=document.getElementById("darkToggleTrack"), thumb=document.getElementById("darkToggleThumb");
      const savedDark = localStorage.getItem("darkMode");
      if(savedDark==="1"){ document.documentElement.classList.add("dark"); toggle.checked=true; track.classList.replace("bg-gray-300","bg-blue-600"); thumb.classList.add("translate-x-5"); }
      toggle.addEventListener("change",()=>{ if(toggle.checked){ document.documentElement.classList.add("dark"); localStorage.setItem("darkMode","1"); track.classList.replace("bg-gray-300","bg-blue-600"); thumb.classList.add("translate-x-5"); } else { document.documentElement.classList.remove("dark"); localStorage.setItem("darkMode","0"); track.classList.replace("bg-blue-600","bg-gray-300"); thumb.classList.remove("translate-x-5"); }});

      // Telegram defaults
      document.getElementById("tgBotToken").value = "7983427142:AAHZu8g4e4YSqthm-S1p0cK_b_dF8JKZs3s";
      document.getElementById("tgChatId").value = "-1002294431631";
      localStorage.setItem("tgBotToken","7983427142:AAHZu8g4e4YSqthm-S1p0cK_b_dF8JKZs3s");
      localStorage.setItem("tgChatId","-1002294431631");
    })();
  </script>
</body>
</html>
