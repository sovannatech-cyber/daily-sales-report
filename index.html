<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Daily Sales Report</title>

  <!-- Khmer Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas for PNG capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body { font-family: 'Noto Sans Khmer', sans-serif; }
    .print-only { display: none; }
    .screen-only { display: block; }
    @media print {
      button, .hidden-print, .screen-only { display: none !important; }
      .print-only { display: block !important; }
      body { background: #fff; }
    }
    .capture-mode button,
    .capture-mode .hidden-print,
    .capture-mode .screen-only { display: none !important; }
    .capture-mode .print-only { display: block !important; }
  </style>
</head>

<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 p-4">
  <div id="reportCard" class="max-w-3xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-2xl shadow">

    <!-- Sticky Header -->
    <div class="sticky top-0 bg-white dark:bg-gray-800 z-20 pb-2 border-b border-gray-200 dark:border-gray-700">
      <h1 class="text-2xl font-bold text-center py-2">
        ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†ááŸ’á„áŸƒ<br />
        <span class="text-sm">(Daily Sales Report)</span>
      </h1>
      <div class="mb-2 flex justify-between items-center">
        <label class="text-sm">á€á¶á›á”ášá·á…áŸ’á†áŸá‘ (Date)</label>
        <input type="date" id="reportDate"
          class="p-1 border rounded screen-only bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        <div class="print-only text-sm mt-1">Date: <span id="dateFormattedPrint">â€”</span></div>
      </div>
    </div>

    <!-- Sales -->
    <h2 class="text-xl font-semibold mb-2 mt-4">I. á€á¶ášá›á€áŸ‹ (Sales)</h2>
    <table class="w-full border text-sm mb-3 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100">
      <thead class="bg-gray-100 dark:bg-gray-700">
        <tr>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Customer</th>
          <th class="border px-2 py-1 text-right dark:border-gray-600">Amount (áŸ›)</th>
        </tr>
      </thead>
      <tbody id="salesContainer"></tbody>
    </table>
    <button id="btnAddSale" class="bg-blue-500 text-white px-3 py-1 rounded hidden-print flex items-center gap-2
           dark:bg-blue-600 dark:hover:bg-blue-500">â• Customer</button>
    <div class="mt-2 font-bold">áŸášá»á”á€á¶ášá›á€áŸ‹ (A) Total Sales: <span id="totalSales">0</span> áŸ›</div>

    <!-- Purchases -->
    <h2 class="text-xl font-semibold mt-6 mb-2">II. á€á¶ášá‘á·á‰ (Purchases)</h2>
    <table class="w-full border text-sm mb-3 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100">
      <thead class="bg-gray-100 dark:bg-gray-700">
        <tr>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Supplier</th>
          <th class="border px-2 py-1 text-right dark:border-gray-600">Amount (áŸ›)</th>
        </tr>
      </thead>
      <tbody id="purchaseContainer"></tbody>
    </table>
    <button id="btnAddPurchase" class="bg-green-500 text-white px-3 py-1 rounded hidden-print flex items-center gap-2
           dark:bg-green-600 dark:hover:bg-green-500">ğŸ“¦ Supplier</button>
    <div class="mt-2 font-bold">áŸášá»á”á€á¶ášá‘á·á‰ (B) Total Purchases: <span id="totalPurchases">0</span> áŸ›</div>

    <!-- Expenses -->
    <h2 class="text-xl font-semibold mt-6 mb-2">III. á€á¶ášá…áŸ†áá¶á™ (Expenses)</h2>
    <table class="w-full border text-sm mb-3 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100">
      <thead class="bg-gray-100 dark:bg-gray-700">
        <tr>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Expense Type</th>
          <th class="border px-2 py-1 text-right dark:border-gray-600">Amount (áŸ›)</th>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Note</th>
        </tr>
      </thead>
      <tbody id="expenseContainer"></tbody>
    </table>
    <button id="btnAddExpense" class="bg-yellow-500 text-white px-3 py-1 rounded hidden-print flex items-center gap-2
           dark:bg-yellow-600 dark:hover:bg-yellow-500">ğŸ’° Expense</button>
    <div class="mt-2 font-bold">áŸášá»á”á…áŸ†áá¶á™ (C) Total Expenses: <span id="totalExpenses">0</span> áŸ›</div>

    <!-- Totals -->
    <div class="mt-6 space-y-2">
      <div class="flex justify-between items-center">
        <label class="font-semibold">IV. á…áŸ†ááŸá‰áŸášá»á” (D=A-B-C) Total Profit:</label>
        <span id="totalProfit" class="font-bold">0 áŸ›</span>
      </div>
      <div class="flex justify-between items-center">
        <label class="font-semibold">V. á‘á¹á€á”áŸ’ášá¶á€áŸ‹ááŸ’ášá¼áœá•áŸ’á‘áŸáš (E=B+C):</label>
        <span id="totalTransfer" class="font-bold text-purple-700">0 áŸ›</span>
      </div>
      <div class="flex justify-between items-center">
        <label class="font-semibold">VI. á”áŸ’ášá¶á€áŸ‹á€á€áŸ‹ (F) Petty Cash Balance:</label>
        <input type="number" id="pettyCash"
               class="w-32 p-2 border rounded text-right screen-only bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        <span class="print-only" id="pettyCashPrint">0</span>
      </div>
    </div>

    <!-- Buttons -->
    <div class="mt-4 space-y-2 hidden-print">
      <!-- Share first -->
      <button id="btnShareTelegram" class="w-full bg-sky-600 text-white py-2 rounded dark:bg-sky-700 dark:hover:bg-sky-600">Share to Telegram</button>
      <button id="btnSaveImage" class="w-full bg-emerald-600 text-white py-2 rounded dark:bg-emerald-700 dark:hover:bg-emerald-600">Save as Image (PNG)</button>
      <button onclick="window.print()" class="w-full bg-gray-700 text-white py-2 rounded dark:bg-gray-800 dark:hover:bg-gray-600">Print</button>
      <button id="btnClearReport" class="w-full bg-red-500 text-white py-2 rounded dark:bg-red-600 dark:hover:bg-red-500">Clear Report</button>
    </div>

    <!-- Telegram Settings (pre-filled) -->
    <div class="screen-only mt-4 p-3 border rounded space-y-2 dark:border-gray-700 dark:bg-gray-800">
      <div class="text-sm font-semibold">Telegram Settings</div>
      <input id="tgBotToken" type="password"
        class="w-full p-2 border rounded bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        value="7983427142:AAHZu8g4e4YSqthm-S1p0cK_b_dF8JKZs3s" readonly />
      <input id="tgChatId" type="text"
        class="w-full p-2 border rounded bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        value="-1002294431631" readonly />
      <label class="flex items-center gap-2 text-sm">
        <input id="tgIncludeCaption" type="checkbox" class="w-4 h-4" checked />
        <span>Include caption (A/B/C/D/E totals) when sharing</span>
      </label>
      <p class="text-xs text-gray-500 dark:text-gray-400">Pre-configured for Khmer Flavor Mart group.</p>
    </div>
  </div>

  <!-- JS -->
  <script>
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // PNG Save
    function saveAsImage() {
      const card = document.getElementById("reportCard");
      document.body.classList.add("capture-mode");

      html2canvas(card, { scale: 2 }).then(canvas => {
        document.body.classList.remove("capture-mode");
        const link = document.createElement("a");
        link.download = "DailySalesReport.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }
    document.getElementById("btnSaveImage").addEventListener("click", saveAsImage);

    // Share to Telegram
    function shareToTelegram() {
      const token = document.getElementById("tgBotToken").value;
      const chatId = document.getElementById("tgChatId").value;
      const includeCaption = document.getElementById("tgIncludeCaption").checked;
      const dateVal = document.getElementById("reportDate").value || "Today";

      const caption = includeCaption ?
        `ğŸ“Š Daily Sales Report (${dateVal})
A: Sales = ${document.getElementById("totalSales").textContent} áŸ›
B: Purchases = ${document.getElementById("totalPurchases").textContent} áŸ›
C: Expenses = ${document.getElementById("totalExpenses").textContent} áŸ›
D: Profit = ${document.getElementById("totalProfit").textContent}
E: Transfer = ${document.getElementById("totalTransfer").textContent}` : "";

      const card = document.getElementById("reportCard");
      document.body.classList.add("capture-mode");

      html2canvas(card, { scale: 2 }).then(canvas => {
        document.body.classList.remove("capture-mode");
        const photoData = canvas.toDataURL("image/png");

        fetch(`https://api.telegram.org/bot${token}/sendPhoto`, {
          method: "POST",
          body: new URLSearchParams({
            chat_id: chatId,
            caption: caption,
            photo: photoData
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            alert("âœ… Report sent to Telegram group!");
          } else {
            alert("âŒ Failed: " + data.description);
          }
        })
        .catch(err => alert("Error: " + err.message));
      });
    }
    document.getElementById("btnShareTelegram").addEventListener("click", shareToTelegram);
  </script>
</body>
</html>
