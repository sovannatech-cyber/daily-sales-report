<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Daily Sales Report</title>
  
  <!-- Khmer Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Noto Sans Khmer', sans-serif; }
    .print-only { display: none; }
    .screen-only { display: block; }
    @media print { button, .hidden-print, .screen-only { display: none !important; } .print-only { display: block !important; } body { background: #fff; } }
    .capture-mode button, .capture-mode .hidden-print, .capture-mode .screen-only { display: none !important; }
    .capture-mode .print-only { display: block !important; }
    button:disabled { opacity: .6; cursor: not-allowed; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 p-4">
  <div id="reportCard" class="max-w-3xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-2xl shadow">

    <!-- Header -->
    <div class="sticky top-0 bg-white dark:bg-gray-800 z-20 pb-2 border-b border-gray-200 dark:border-gray-700">
      <h1 class="text-2xl font-bold text-center py-2">
        របាយការណ៍ប្រចាំថ្ងៃ<br />
        <span class="text-sm">(Daily Sales Report)</span>
      </h1>
      <div class="mb-2 flex justify-between items-center">
        <label class="text-sm" for="reportDate">កាលបរិច្ឆេទ (Date)</label>
        <input type="date" id="reportDate" required class="p-1 border rounded screen-only bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        <div class="print-only text-sm mt-1">Date: <span id="dateFormattedPrint">—</span></div>
      </div>
    </div>

    <!-- Sales -->
    <h2 class="text-xl font-semibold mb-2 mt-4">I. ការលក់ (Sales)</h2>
    <table class="w-full border text-sm mb-3 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100">
      <thead class="bg-gray-100 dark:bg-gray-700">
        <tr>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Customer</th>
          <th class="border px-2 py-1 text-right dark:border-gray-600">Amount (៛)</th>
        </tr>
      </thead>
      <tbody id="salesContainer"></tbody>
    </table>
    <button id="btnAddSale" class="bg-blue-500 text-white px-3 py-1 rounded hidden-print">➕ Customer</button>
    <div class="mt-2 font-bold">សរុបការលក់ (A): <span id="totalSales">0</span> ៛</div>

    <!-- Purchases -->
    <h2 class="text-xl font-semibold mt-6 mb-2">II. ការទិញ (Purchases)</h2>
    <table class="w-full border text-sm mb-3 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100">
      <thead class="bg-gray-100 dark:bg-gray-700">
        <tr>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Supplier</th>
          <th class="border px-2 py-1 text-right dark:border-gray-600">Amount (៛)</th>
        </tr>
      </thead>
      <tbody id="purchaseContainer"></tbody>
    </table>
    <button id="btnAddPurchase" class="bg-green-500 text-white px-3 py-1 rounded hidden-print">📦 Supplier</button>
    <div class="mt-2 font-bold">សរុបការទិញ (B): <span id="totalPurchases">0</span> ៛</div>

    <!-- Expenses -->
    <h2 class="text-xl font-semibold mt-6 mb-2">III. ការចំណាយ (Expenses)</h2>
    <table class="w-full border text-sm mb-3 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100">
      <thead class="bg-gray-100 dark:bg-gray-700">
        <tr>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Expense Type</th>
          <th class="border px-2 py-1 text-right dark:border-gray-600">Amount (៛)</th>
          <th class="border px-2 py-1 text-left dark:border-gray-600">Note</th>
        </tr>
      </thead>
      <tbody id="expenseContainer"></tbody>
    </table>
    <button id="btnAddExpense" class="bg-yellow-500 text-white px-3 py-1 rounded hidden-print">💰 Expense</button>
    <div class="mt-2 font-bold">សរុបចំណាយ (C): <span id="totalExpenses">0</span> ៛</div>

    <!-- Totals -->
    <div class="mt-6 space-y-2">
      <div class="flex justify-between"><label>IV. ចំណេញសរុប (D=A-B-C)</label><span id="totalProfit">0 ៛</span></div>
      <div class="flex justify-between"><label>V. ទឹកប្រាក់ត្រូវផ្ទេរ (E=B+C)</label><span id="totalTransfer">0 ៛</span></div>
    </div>

    <!-- Buttons -->
    <div class="mt-4 space-y-2 hidden-print">
      <button id="btnShareTelegram" class="w-full bg-sky-600 text-white py-2 rounded">Share to Telegram</button>
      <button id="btnSaveImage" class="w-full bg-emerald-600 text-white py-2 rounded">Save as Image</button>
      <button id="btnPrint" class="w-full bg-gray-700 text-white py-2 rounded">Print</button>
      <button id="btnRunDiagnostics" class="w-full bg-indigo-600 text-white py-2 rounded">Run Diagnostics</button>
    </div>

    <ul id="diagList" class="mt-2 text-sm list-disc pl-5"></ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const $=(s,r=document)=>r.querySelector(s);const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

    function addRow(containerId, cls){
      const row=document.createElement('tr');
      const td=document.createElement('td');
      const amt=document.createElement('input');
      amt.type='number'; amt.className=cls; amt.placeholder='0';
      amt.addEventListener('input',()=>{calculateTotals();if(Number(amt.value)>0&&!row.nextElementSibling)addRow(containerId,cls);});
      td.appendChild(amt); row.appendChild(td);
      $(containerId).appendChild(row);
    }

    function calculateTotals(){
      const sum=(cls)=>$$('.'+cls).reduce((s,i)=>s+Number(i.value||0),0);
      const A=sum('saleAmount'),B=sum('purchaseAmount'),C=sum('expenseAmount');
      $('#totalSales').textContent=A;$('#totalPurchases').textContent=B;$('#totalExpenses').textContent=C;
      $('#totalProfit').textContent=(A-B-C)+' ៛';$('#totalTransfer').textContent=(B+C)+' ៛';
    }

    async function saveAsImage(){
      const card=$('#reportCard');document.body.classList.add('capture-mode');
      const canvas=await html2canvas(card,{scale:2});document.body.classList.remove('capture-mode');
      const a=document.createElement('a');a.href=canvas.toDataURL('image/png');a.download='Daily_Report.png';a.click();
    }

    async function shareToTelegram(){
      const token="YOUR_BOT_TOKEN";const chatId="YOUR_CHAT_ID";
      const card=$('#reportCard');document.body.classList.add('capture-mode');
      const canvas=await html2canvas(card,{scale:2});document.body.classList.remove('capture-mode');
      const blob=await (await fetch(canvas.toDataURL('image/png'))).blob();
      const fd=new FormData();fd.append('chat_id',chatId);fd.append('photo',blob,'report.png');
      try{await fetch(`https://api.telegram.org/bot${token}/sendPhoto`,{method:'POST',body:fd});alert('✅ Sent');}
      catch(e){alert('❌ Failed: '+e);}
    }

    function runDiagnostics(){
      const l=$('#diagList');l.innerHTML='';
      const add=(lbl,pass,det='')=>{const li=document.createElement('li');li.textContent=`${lbl}: ${pass?'PASS':'FAIL'} ${det}`;li.className=pass?'text-green-600':'text-red-600';l.appendChild(li);}
      addRow('#salesContainer','saleAmount');addRow('#purchaseContainer','purchaseAmount');addRow('#expenseContainer','expenseAmount');
      const s=$$('.saleAmount').slice(-1)[0],p=$$('.purchaseAmount').slice(-1)[0],e=$$('.expenseAmount').slice(-1)[0];
      s.value=1000;s.dispatchEvent(new Event('input',{bubbles:true}));p.value=200;p.dispatchEvent(new Event('input',{bubbles:true}));e.value=300;e.dispatchEvent(new Event('input',{bubbles:true}));
      calculateTotals();
      const A=Number($('#totalSales').textContent),B=Number($('#totalPurchases').textContent),C=Number($('#totalExpenses').textContent);
      const D=parseInt($('#totalProfit').textContent),E=parseInt($('#totalTransfer').textContent);
      add('IV. Totals math',(A===1000&&B===200&&C===300&&D===500&&E===500),`(A=${A},B=${B},C=${C},D=${D},E=${E})`);
    }

    document.addEventListener('DOMContentLoaded',()=>{
      $('#btnAddSale').addEventListener('click',()=>addRow('#salesContainer','saleAmount'));
      $('#btnAddPurchase').addEventListener('click',()=>addRow('#purchaseContainer','purchaseAmount'));
      $('#btnAddExpense').addEventListener('click',()=>addRow('#expenseContainer','expenseAmount'));
      $('#btnSaveImage').addEventListener('click',saveAsImage);
      $('#btnPrint').addEventListener('click',()=>window.print());
      $('#btnShareTelegram').addEventListener('click',shareToTelegram);
      $('#btnRunDiagnostics').addEventListener('click',runDiagnostics);
      addRow('#salesContainer','saleAmount');addRow('#purchaseContainer','purchaseAmount');addRow('#expenseContainer','expenseAmount');
    });
  </script>
</body>
</html>
